<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="1. 安装与准备安装 es 就是按部就班：  查看插件：./elasticsearch-plugin list 安装插件：./elasticsearch-plugin install xxx 部署：./elasticsearch 多节点部署：  123./elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=n">
<meta name="keywords" content="elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch 入门">
<meta property="og:url" content="http://koon.cool/technology/2020-04-01-elasticsearch-learn1/index.html">
<meta property="og:site_name" content="空城">
<meta property="og:description" content="1. 安装与准备安装 es 就是按部就班：  查看插件：./elasticsearch-plugin list 安装插件：./elasticsearch-plugin install xxx 部署：./elasticsearch 多节点部署：  123./elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=n">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2021-11-07T18:01:27.168Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elasticsearch 入门">
<meta name="twitter:description" content="1. 安装与准备安装 es 就是按部就班：  查看插件：./elasticsearch-plugin list 安装插件：./elasticsearch-plugin install xxx 部署：./elasticsearch 多节点部署：  123./elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=n">
    
    
        
          
              <link rel="shortcut icon" href="//koonchenblog-1252050022.cos.ap-shanghai.myqcloud.com/img/blog/fish_opt.png">
          
        
        
          
            <link rel="icon" type="image/png" href="//koonchenblog-1252050022.cos.ap-shanghai.myqcloud.com/img/blog/fish_opt.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="//koonchenblog-1252050022.cos.ap-shanghai.myqcloud.com/img/blog/fish_opt.png">
          
        
    
    <!-- title -->
    <title>Elasticsearch 入门</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">    
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="https://github.com/koonchen">Projects</a></li>
         
          <li><a href="https://valeriehu1995.github.io">PigChain</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/technology/2020-04-15-elasticsearch-learn2/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/technology/2020-02-15-linux-learn2/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&text=Elasticsearch 入门"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&is_video=false&description=Elasticsearch 入门"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Elasticsearch 入门&body=Check out this article: http://koon.cool/technology/2020-04-01-elasticsearch-learn1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&name=Elasticsearch 入门&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-安装与准备"><span class="toc-number">1.</span> <span class="toc-text">1. 安装与准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-基本概念"><span class="toc-number">2.</span> <span class="toc-text">2. 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-CRUD-与批量操作"><span class="toc-number">3.</span> <span class="toc-text">3. CRUD 与批量操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Create"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 Create</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Get"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Get</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Index"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Update"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 Update</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Bulk-API"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 Bulk API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-批量读取-mget"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 批量读取 mget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-批量查询-msearch"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 批量查询 msearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-倒排索引"><span class="toc-number">4.</span> <span class="toc-text">4. 倒排索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Analyzer-分词"><span class="toc-number">5.</span> <span class="toc-text">5. Analyzer 分词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Search-API-概览"><span class="toc-number">6.</span> <span class="toc-text">6. Search API 概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-URI-Search-详解"><span class="toc-number">7.</span> <span class="toc-text">7. URI Search 详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Request-Body-与-Query-DSL"><span class="toc-number">8.</span> <span class="toc-text">8. Request Body 与 Query DSL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Query-String-和-Simple-Query-String-查询"><span class="toc-number">9.</span> <span class="toc-text">9. Query String 和 Simple Query String 查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Dynamic-Mapping-和常见字段类型"><span class="toc-number">10.</span> <span class="toc-text">10. Dynamic Mapping 和常见字段类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-显式-Mapping-设置与常见参数"><span class="toc-number">11.</span> <span class="toc-text">11. 显式 Mapping 设置与常见参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-多字段特性与-Mapping-中自定义-Analyzer"><span class="toc-number">12.</span> <span class="toc-text">12. 多字段特性与 Mapping 中自定义 Analyzer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-Index-Template-和-Dynamic-Template"><span class="toc-number">13.</span> <span class="toc-text">13. Index Template 和 Dynamic Template</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-es-聚合分析"><span class="toc-number">14.</span> <span class="toc-text">14. es 聚合分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-总结"><span class="toc-number">15.</span> <span class="toc-text">15. 总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Elasticsearch 入门
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">空城</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-03-31T16:00:00.000Z" itemprop="datePublished">2020-04-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/technology/">technology</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/elasticsearch/">elasticsearch</a>
    </div>


    </div>
  </header>
  <!-- 
 -->
  <div class="content" itemprop="articleBody">
    <h2 id="1-安装与准备"><a href="#1-安装与准备" class="headerlink" title="1. 安装与准备"></a>1. 安装与准备</h2><p>安装 es 就是按部就班：</p>
<ul>
<li>查看插件：<code>./elasticsearch-plugin list</code></li>
<li>安装插件：<code>./elasticsearch-plugin install xxx</code></li>
<li>部署：<code>./elasticsearch</code></li>
<li>多节点部署：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -d</span><br><span class="line">./elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -d</span><br><span class="line">./elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data -d</span><br></pre></td></tr></table></figure>
<ul>
<li>删除部署的节点：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep elasticsearch | awk <span class="string">'&#123;print $2&#125;'</span> | xargs kill -<span class="number">9</span></span><br></pre></td></tr></table></figure>
<ul>
<li>部署查询：<a href="http://localhost:9200/_cat/nodes" target="_blank" rel="noopener">http://localhost:9200/_cat/nodes</a></li>
</ul>
<p>安装一下 Kibana ，端口是 5601 :</p>
<ul>
<li>查看插件 <code>./kibana-plugin list</code></li>
<li>安装插件 <code>./kibana-plugin install xxx</code></li>
</ul>
<p>当然也能用 docker 装。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2.2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  cerebro:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">lmenezes/cerebro:0.9.1</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">cerebro</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"9000:9000"</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="bullet">-Dhosts.0.host=http://elasticsearch:9200</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">es7net</span></span><br><span class="line"><span class="attr">  kibana:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.elastic.co/kibana/kibana:7.7.0</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">kibana7</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">I18N_LOCALE=zh-CN</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">XPACK_GRAPH_ENABLED=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">TIMELION_ENABLED=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">XPACK_MONITORING_COLLECTION_ENABLED="true"</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"5601:5601"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">es7net</span></span><br><span class="line"><span class="attr">  elasticsearch:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.7.0</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">es7_01</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cluster.name=geektime</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node.name=es7_01</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">discovery.seed_hosts=es7_01,es7_02</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cluster.initial_master_nodes=es7_01,es7_02</span></span><br><span class="line"><span class="attr">    ulimits:</span></span><br><span class="line"><span class="attr">      memlock:</span></span><br><span class="line"><span class="attr">        soft:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">        hard:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - es7data1:</span><span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">es7net</span></span><br><span class="line"><span class="attr">  elasticsearch2:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.7.0</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">es7_02</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cluster.name=geektime</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node.name=es7_02</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">discovery.seed_hosts=es7_01,es7_02</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cluster.initial_master_nodes=es7_01,es7_02</span></span><br><span class="line"><span class="attr">    ulimits:</span></span><br><span class="line"><span class="attr">      memlock:</span></span><br><span class="line"><span class="attr">        soft:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">        hard:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - es7data2:</span><span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">es7net</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  es7data1:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">  es7data2:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  es7net:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>一个 cerebro 0.9.1、一个 kibana 7.7.0、两个 es 7.7.0。</p>
</blockquote>
<p>接着是 Logstash ，尝试将 movielens 数据集写入 es ，使用指令：<code>./logstash -f logstash.conf</code> 执行。</p>
<blockquote>
<p>需要提前准备数据集。不再继续打印输信息了，就算结束了。logstash 会监听文件，如有变化，会继续更新。</p>
</blockquote>
<h2 id="2-基本概念"><a href="#2-基本概念" class="headerlink" title="2. 基本概念"></a>2. 基本概念</h2><p>ES 是面向文档的，文档被保存成 JSON 格式，每一个文档都有一个 Unique ID。</p>
<blockquote>
<p>每一个文档都有『元数据』，<code>_index</code> 文档索引名，<code>_type</code> 文档所属的类型名，<code>_id</code> 唯一 ID，<code>_source</code> 原始 JSON，<code>_all</code> 整合所有内容（已经废除），<code>_version</code> 文档版本信息，<code>_score</code> 相关性打分。</p>
</blockquote>
<p><strong>索引 Index 是文档的容器，表示一类文档的集合。</strong></p>
<ul>
<li>Index 提现了逻辑空间的概念。每个索引都有自己的 Mapping ，用于定义包含文档的字段与类型。</li>
<li>Shard 是物理空间的概念。索引中的数据分散在 Shard 中。</li>
<li>Mapping 定义字段类型，Setting 定义不同的数据分布。</li>
</ul>
<p>索引在 es 中也可以给表示动词：索引（动）文档到 es 的索引（名）中。</p>
<blockquote>
<p>动词『索引』指保存的意思。</p>
</blockquote>
<p>在 7.0 前，一个 Index 可以设置多个 Type ，但是 7.0 开始一个索引只能设置一个 Type <code>_doc</code> 。</p>
<p>与 RDBMS 相比，es 中与之对应的概念：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>RDBMS</th>
<th>Elasticsearch</th>
</tr>
</thead>
<tbody>
<tr>
<td>Table</td>
<td>Index(Type)</td>
</tr>
<tr>
<td>Row</td>
<td>Document</td>
</tr>
<tr>
<td>Column</td>
<td>Filed</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
</tr>
<tr>
<td>SQL</td>
<td>DSL</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>es 偏向于相关性的全文检索；</li>
<li>RDBMS 事务性更强。</li>
</ul>
<p>节点与分片是重要的概念：</p>
<ul>
<li>es 不同的集群通过名字来划分，默认为『elasticsearch』。通过 <code>-E cluster.name=xxx</code> 来设置集群名字，一个集群有一个或多个节点。</li>
<li>节点是一个 es 的实例，本质上是一个进程，生产环境推荐一台机器一个实例（节点），每个节点都有名字通过 <code>-E node.name=xxx</code> 来设置，每个节点启动后会有一个 UID，保存在 data 目录下。</li>
<li>每个节点启动默认是一个『Master-eligible』节点，可以通过设置 <code>node.master: false</code> 禁止，只有 Master 节点可以修改集群的状态信息。<ul>
<li>Data Node 是可以保存数据的节点，负责保存分片数据；</li>
<li>Coordinating Node 负责接收 Client 的请求，将请求分发到合适的节点上，最终将结果聚集返回（每个节点默认都有 Coordinating Node 的职责）；</li>
<li>Hot Node 是配置比较高的节点（一般而言），而 Warm Node 则保存比较旧的数据（一般配置较低）；</li>
<li>Machine Learning Node 负责机器学习的 Job ，用来异常检测；</li>
<li>Tribe Node 逐渐淘汰，改用 Cross Cluster Search 用于连接不同的集群，将这些集群当做一个集群。</li>
</ul>
</li>
</ul>
<blockquote>
<p>开发环境一个节点可以承担多个角色，生产环境则应该设置单一角色。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> master eligible</span><br><span class="line">node.master = true</span><br><span class="line"><span class="meta">#</span> data</span><br><span class="line">node.data = true</span><br><span class="line"><span class="meta">#</span> ingest</span><br><span class="line">node.ingest = true</span><br><span class="line"><span class="meta">#</span> ml</span><br><span class="line">node.ml = true</span><br><span class="line"><span class="meta">#</span> coordinating</span><br><span class="line"><span class="meta">#</span> 无</span><br></pre></td></tr></table></figure>
<ul>
<li>Primary Shard，主分片，解决水平扩展的问题，将数据分布到集群内所有节点上。<ul>
<li>一个分片是一个 Lucene 实例。</li>
<li>主分片数在索引创建时指定，后续不能更改，除非 Reindex。</li>
</ul>
</li>
<li>Replica Shard，副本，用于解决数据高可用的问题，分片是主分片的拷贝。<ul>
<li>副本分片可以动态调整。</li>
<li>增加副本数，可以在一定程度上提高服务的可用性。</li>
</ul>
</li>
<li>主分片如果过小，导致无法增加节点实现水平扩展，同时单个节点数据量过大，数据查询耗时。</li>
<li>主分片如果过大，默认是 1 ，将影响搜索结果的相关性打分，同时单个节点上分片过多，会资源浪费，同时影响性能。</li>
</ul>
<p>集群有健康状况 <code>GET _cluster/health</code> ，Green 都正常，Yellow 主正常部分副本不正常，Red 主不正常。</p>
<h2 id="3-CRUD-与批量操作"><a href="#3-CRUD-与批量操作" class="headerlink" title="3. CRUD 与批量操作"></a>3. CRUD 与批量操作</h2><p>Http Method + Index Name + Type + Doc Id。</p>
<ul>
<li>Type 约定用 <code>_doc</code>；</li>
<li>Create 如果 Id 存在，会失败；</li>
<li>Index 如果 Id 不存在，创建新的文档，否则删除现有文档，再创建新的文档，版本会增加；</li>
<li>Update 如果文档存在，更新只会对相应字段做增量操作；</li>
</ul>
<h3 id="3-1-Create"><a href="#3-1-Create" class="headerlink" title="3.1 Create"></a>3.1 Create</h3><ul>
<li>通过 <code>post /users/_doc</code> 系统自动生成 Doc Id；</li>
<li>使用 <code>put user/_create/1</code> 或 <code>put users/_doc/1?op_type=create</code> 显式指定 Id ，如果 Id 存在，则失败；<ul>
<li>先执行了自动生成，再执行手动指定的时候，会成功，但是第二次执行会失败（因为自动生成的 Id 是随机的，不会在这里发生冲突）</li>
</ul>
</li>
</ul>
<h3 id="3-2-Get"><a href="#3-2-Get" class="headerlink" title="3.2 Get"></a>3.2 Get</h3><ul>
<li>找到则返回 200 <code>get users/_doc/1</code>；<ul>
<li><code>_version</code> 表示文档经过多少次改动；</li>
</ul>
</li>
<li>找不到则 404</li>
</ul>
<h3 id="3-3-Index"><a href="#3-3-Index" class="headerlink" title="3.3 Index"></a>3.3 Index</h3><blockquote>
<p>如果文档不存在，就创建新的文档；否则现有文档被删除，再创建新的文档，版本增加。</p>
</blockquote>
<ul>
<li>使用 <code>put user/_doc/1</code> 进行操作；</li>
</ul>
<h3 id="3-4-Update"><a href="#3-4-Update" class="headerlink" title="3.4 Update"></a>3.4 Update</h3><blockquote>
<p>不会删除原有的文档，而是实现真正的数据更新。</p>
</blockquote>
<ul>
<li>使用 <code>post users/_update/1</code> 进行操作；</li>
<li>在执行时必须指明 <code>doc</code> ；</li>
</ul>
<h3 id="3-5-Bulk-API"><a href="#3-5-Bulk-API" class="headerlink" title="3.5 Bulk API"></a>3.5 Bulk API</h3><ul>
<li>在一次 API 调用中，对不同的索引进行操作，支持：Index Create Update Delete。</li>
<li>单条操作失败不会影响其他结果；最终结果包含每一条操作。</li>
<li>以 <code>post _bulk</code> 开始，其中指定各种 Index 。</li>
</ul>
<h3 id="3-6-批量读取-mget"><a href="#3-6-批量读取-mget" class="headerlink" title="3.6 批量读取 mget"></a>3.6 批量读取 mget</h3><ul>
<li>批量操作，用 Id 获得详情，减少网络连接所产生的开销，提高性能。</li>
<li>以 <code>get _mget</code> 开始，可以在 URI 中指定 Index，也可以在请求体中说明 Index。</li>
</ul>
<h3 id="3-7-批量查询-msearch"><a href="#3-7-批量查询-msearch" class="headerlink" title="3.7 批量查询 msearch"></a>3.7 批量查询 msearch</h3><ul>
<li>以 <code>post _msearch</code> 开始，API 更加丰富，根据条件进行查询。</li>
</ul>
<blockquote>
<p>429 集群繁忙。</p>
</blockquote>
<h2 id="4-倒排索引"><a href="#4-倒排索引" class="headerlink" title="4. 倒排索引"></a>4. 倒排索引</h2><p>目录是正排索引 Id -&gt; 内容，书的结尾的索引页是倒排索引 内容 -&gt; Id。</p>
<p>倒排索引包括两个部分：</p>
<ul>
<li>单词词典 Term Dictionary，记录所有文档的单词，记录单词到倒排索引的关系，可以用 B+ 树或哈希拉链，满足高性能的插入与查询。</li>
<li>倒排列表 Posting List，记录单词对应的文档结合，由倒排索引项组成。倒排索引项包括：<ul>
<li>文档 Id</li>
<li>词频 TF</li>
<li>位置，用于语句搜索</li>
<li>偏移，单词开始到结束的位置，高亮显示</li>
</ul>
</li>
</ul>
<h2 id="5-Analyzer-分词"><a href="#5-Analyzer-分词" class="headerlink" title="5. Analyzer 分词"></a>5. Analyzer 分词</h2><p>Analysis 文本分析可以把全文文本转化成一系列单词，也就是分词。Analysis 是通过 Analyzer 实现的。</p>
<p>Analyzer 分词器由三个部分组成：Character Filters 针对原始文本进行处理、Tokenizer 根据一定规则进行字符串切分、Token Filters 将切分结果进行二次加工。</p>
<ul>
<li>Standard Analyzer - 是默认分词器，按词进行切分，小写处理。</li>
<li>Simple Analyzer – 按照非字母切分（符号、数字被过滤），小写处理</li>
<li>Stop Analyzer – 小写处理，停用词过滤（the，a，is）</li>
<li>Whitespace Analyzer – 按照空格切分，不转小写</li>
<li>Keyword Analyzer – 不分词，直接将输入当作输出</li>
<li>Patter Analyzer – 正则表达式，默认 \W+ (非字符分隔)</li>
<li>Language – 提供了30多种常见语言的分词器</li>
<li>ICU Analyzer - 中文分词，提供 Unicode 支持，Character Filters 是 Normalization，Tokenizer 是 ICU Tokenizer，Token Filters 是 Normalization + Folding + Collation + Transform。</li>
</ul>
<blockquote>
<p><code>get /_analyze</code> 指定 Analyzer 进行分词，<code>post xxx/_analyze</code> 指定索引字段进行分词，<code>post /_analyzer</code> 自定义分词器进行分词。</p>
</blockquote>
<h2 id="6-Search-API-概览"><a href="#6-Search-API-概览" class="headerlink" title="6. Search API 概览"></a>6. Search API 概览</h2><ul>
<li>URI Search<ul>
<li>在 URL 中使用查询参数。</li>
<li>使用 get 方法，在 URL 中使用 <code>q</code> 指定查询字符串，字符串是 <code>k:v</code> 形式的键值对。</li>
</ul>
</li>
<li>Request Body Search<ul>
<li>使用 es 提供的，基于 JSON 格式的更加完备的 DSL 。</li>
<li>使用 get 或 post 方法，在请求体中使用 DSL 。</li>
<li><code>/_search</code> 查询集群上所有的索引。</li>
<li><code>/index1/_search</code> 查询 index1 索引上的内容。</li>
<li><code>/index1,index2/_search</code> 查询 index1 和 index2 索引上的内容。</li>
<li><code>/index*/_search</code> 匹配 index 开头的索引上的内容。</li>
</ul>
</li>
</ul>
<p>响应结果中：</p>
<ul>
<li>took 花费时间。</li>
<li>total 符合条件的文档总数。</li>
<li>hits 结果集，默认前 10 个文档。</li>
</ul>
<p>另外一个重点在于 score ：</p>
<ul>
<li>搜索结果会根据 score 进行排名。</li>
<li>Precision 查准率 = True Positive / 全部返回的结果</li>
<li>Recall 查全率 = True Positive / 所有应该返回的结果</li>
<li>使用 es 的查询和相关参数可以改善搜索的 Precision 和 Recall 。</li>
</ul>
<h2 id="7-URI-Search-详解"><a href="#7-URI-Search-详解" class="headerlink" title="7. URI Search 详解"></a>7. URI Search 详解</h2><ul>
<li><code>q</code> 查询语句，使用 Query String Syntax。</li>
<li><code>df</code> 默认字段，不指定时，返回所有字段的查询。</li>
<li><code>sort</code> 排序。</li>
<li><code>from</code> 和 <code>size</code> 用于分页。</li>
<li>请求体里的 <code>Profile</code> 查看查询是如何被执行的。</li>
<li>指定字段查询 <code>q=title:2012</code>，范查询则是 <code>q=2012</code>。</li>
<li>Term vs Phrase<ul>
<li>Beautiful Mind 等效于 Beautiful OR Mind <code>title:(Beautiful AND Mind)</code>。</li>
<li>“Beautiful Mind” 等效于 Beautiful AND Mind，同时要求顺序一致 <code>title=&quot;Beautiful Mind&quot;</code>。</li>
</ul>
</li>
<li>布尔操作<ul>
<li><code>AND</code> <code>$$</code></li>
<li><code>OR</code> <code>||</code></li>
<li><code>NOT</code> <code>!</code></li>
</ul>
</li>
<li>分组操作<ul>
<li><code>+</code> 或 <code>%2B</code> 必须要。</li>
<li><code>-</code> 一定不要。</li>
<li><code>title:(Beautiful %2BMind)</code> 这种情况下 Mind 不需要有，Beautiful 可以没有。</li>
</ul>
</li>
<li>范围查询<ul>
<li><code>[]</code> 闭区间，<code>{}</code> 开区间。</li>
<li><code>year:{2018 TO 2019]</code></li>
<li><code>year:[* TO 2019]</code></li>
</ul>
</li>
<li>数学符号<ul>
<li><code>year:&gt;2010</code></li>
<li><code>year:(&gt;2010 %% &lt;=2018)</code></li>
<li><code>year:(+&gt;2010 +&lt;=2018)</code></li>
</ul>
</li>
<li>当然也能有通配符、正则.</li>
<li>模糊与近似查询<ul>
<li><code>title:beautifl~1</code> 可以找到拼写完整的 befautiful。</li>
<li><code>title:&quot;lord rings&quot;~2</code> 可以找到 lord of the rings。</li>
</ul>
</li>
</ul>
<h2 id="8-Request-Body-与-Query-DSL"><a href="#8-Request-Body-与-Query-DSL" class="headerlink" title="8. Request Body 与 Query DSL"></a>8. Request Body 与 Query DSL</h2><ul>
<li>推荐用 Request Body Search，有些操作这能在这里用。</li>
<li>请求体的 <code>query</code> 中 <code>&quot;match_all&quot;:{}</code> 查询所有文档。</li>
<li>请求体的 <code>from</code> 从 0 开始，默认返回 10 个结果。</li>
<li>请求体的 <code>sort</code> 可以进行排序，比如 <code>&quot;sort&quot;:[{&quot;order_date&quot;:&quot;desc&quot;}]</code>。最好是数字和日期。</li>
<li>请求体的 <code>_source</code> 可以进行过滤，比如 <code>&quot;_source&quot;:[&quot;order_date&quot;,&quot;category.keyword&quot;]</code>。</li>
<li>URI 中的参数 <code>ignore_unavailable=true</code> 可以忽略访问不存在的索引导致的报错。</li>
<li>请求体中使用 <code>script_fields</code> 表示脚本字段，比如如下例子：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"script_fields"</span>: &#123;</span><br><span class="line">    <span class="string">"test_field"</span>: &#123; <span class="comment"># 自定义的名称</span></span><br><span class="line">      <span class="string">"script"</span>: &#123;</span><br><span class="line">        <span class="string">"lang"</span>: <span class="string">"painless"</span>,</span><br><span class="line">        <span class="string">"source"</span>: <span class="string">"doc['order_date'].value+'hello'"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"_source"</span>:[<span class="string">"order_date"</span>],</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>比如计算汇率的时候可以用到。</p>
</blockquote>
<ul>
<li>Match 请求对应了 Term 操作，在请求体的 <code>query</code> 中使用 <code>match</code> 开始，默认的 <code>operator</code> 是 OR，比如如下例子：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"title"</span>: &#123;</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"last christmas"</span>,</span><br><span class="line">        <span class="string">"operator"</span>: <span class="string">"AND"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>响应的也有 Match Phrase 查询对应了 Phrase 操作，在请求体的 <code>query</code> 中使用 <code>match_phrase</code> 开始，如下：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match_phrase"</span>: &#123;</span><br><span class="line">      <span class="string">"title"</span>:&#123;</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"one love"</span>,</span><br><span class="line">        <span class="string">"slop"</span>: <span class="number">1</span> <span class="comment"># 表示允许中间可以有 1 个其他的字符</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以输出 <code>&quot;title&quot; : &quot;One I Love, The&quot;</code>。</p>
</blockquote>
<h2 id="9-Query-String-和-Simple-Query-String-查询"><a href="#9-Query-String-和-Simple-Query-String-查询" class="headerlink" title="9. Query String 和 Simple Query String 查询"></a>9. Query String 和 Simple Query String 查询</h2><ul>
<li>类似与 URI Query。</li>
<li>在请求体的 <code>query</code> 中使用 <code>query_string</code> 进行填充，df = default_field，在其中也能用到 <code>query</code>。</li>
<li><code>simple_query_string</code> 和 <code>query_string</code> 类似，但是会忽略一些错误的语法，同时只支持部分查询。<ul>
<li>不支持 AND OR NOT，都当做字符串处理。</li>
<li>Term 之间默认关系是 OR，但是可以指定 Operator。</li>
<li>支持逻辑，<code>+</code> 代替 <code>AND</code>，<code>|</code> 代替 <code>OR</code>，<code>-</code> 代替 <code>NOT</code>。</li>
</ul>
</li>
</ul>
<h2 id="10-Dynamic-Mapping-和常见字段类型"><a href="#10-Dynamic-Mapping-和常见字段类型" class="headerlink" title="10. Dynamic Mapping 和常见字段类型"></a>10. Dynamic Mapping 和常见字段类型</h2><ul>
<li>Mapping 和 Dynamic Mapping<ul>
<li>Mapping 类似于 DB 中的 schema，可以定义索引中的字段，定义字段类型，进行倒排索引配置。</li>
<li>Mapping 会将 JSON 映射成 Lucene 所需要的扁平格式。</li>
</ul>
</li>
<li>字段类型自动识别<ul>
<li>简单类型有 Text/Keyword，Date，Integer/Floating，Boolean，IPv4/IPv6。</li>
<li>复杂类型有对象和嵌套类型。</li>
<li>特殊类型有 geo_point/geo_shape/percolator。</li>
</ul>
</li>
<li>控制 Mapping 的 Dynamic 属性<ul>
<li>一个 Mapping 属于一个索引的 Type，现在一个索引只能有一个 Type。</li>
</ul>
</li>
<li>Dynamic Mapping 是在写入文档的时候，如果索引不存在就会自动创建索引，但是类型推断有时候会发生错误。<ul>
<li>字符串且匹配日期格式，自动为 Date。</li>
<li>字符串且匹配数字，设置 float 或 long，该转换默认关闭。</li>
<li>其他字符串则为 Text。</li>
<li>布尔对应 boolean。</li>
<li>浮点对应 float。</li>
<li>整数对应 long。</li>
<li>对象对应 Object。</li>
<li>数组由第一个非空数值类型决定。</li>
<li>控制直接忽略。</li>
</ul>
</li>
<li>如果 Dynamic 为 true，一旦有新字段加入，Mapping 会更新；如果 Dynamic 为 false，新字段无法被索引，但是信息会在 <code>_source</code> 中；如果 Dynamic 是 strict，文档写入失败。</li>
<li>对于已经有了的字段，一旦已经有数据写入，则不再支持字段定义的更改。</li>
<li>更改字段类型需要 Reindex API，重建索引。</li>
</ul>
<h2 id="11-显式-Mapping-设置与常见参数"><a href="#11-显式-Mapping-设置与常见参数" class="headerlink" title="11. 显式 Mapping 设置与常见参数"></a>11. 显式 Mapping 设置与常见参数</h2><ul>
<li>可以参考 API 手册，纯手写。<ul>
<li>创建一个临时 Index，写入一些样本数据。</li>
<li>通过访问 Mapping API 获得该临时文件的动态 Mapping 定义。</li>
<li>修改该定义为你的索引。</li>
<li>删除临时索引。</li>
</ul>
</li>
<li><code>index</code> 控制是否字段被索引，false 时，倒排索引就不会被生成了。</li>
<li><code>index_options</code> 倒排索引的四个级别。<ul>
<li><code>docs</code> 记录 doc id。（除 Text 默认）</li>
<li><code>freqs</code> 记录 doc id 和 term frequencies。</li>
<li><code>positions</code> 记录 doc id 和 term frequencies 和 term position。（Text 默认）</li>
<li><code>offsets</code> 记录 doc id 和 term frequencies 和 term position 和 character offects。</li>
</ul>
</li>
<li>如果需要对 Null 值进行搜索，在 Keyword 类型下支持设定 <code>null_value</code>，在搜索时是真正的 Null 值。</li>
<li><code>_all</code> 被 <code>copy_to</code> 替代，将字段值拷贝到目标字段，搜索可以用目标字段搜索，<code>copy_to</code> 字段不会出现在 <code>_source</code> 中。</li>
<li>es 没有专门的数组类型，但是任何字段都可以包含多个相同类型的数值。</li>
</ul>
<h2 id="12-多字段特性与-Mapping-中自定义-Analyzer"><a href="#12-多字段特性与-Mapping-中自定义-Analyzer" class="headerlink" title="12. 多字段特性与 Mapping 中自定义 Analyzer"></a>12. 多字段特性与 Mapping 中自定义 Analyzer</h2><ul>
<li>对某一个字段增加一个子字段，也可以指定不同的 Analyzer 进行分词。</li>
<li>es 中的 Keyword 是一种精确值，包括数字、日期、具体的字符串，没有必要对其进一步分词；而全文本是非结构化的文本数据，就是 es 中的 Text。</li>
<li>当自带分词器无法满足需求，可以自定义分词器。<ul>
<li>Character Filter 分此前对文本进行特殊处理，会影响 position 和 offset 的信息，HTML Strip 去除 html 标签，Mapping 字符串替换，Pattern Replace 正则替换。</li>
<li>Tokenizer 分词时把文本按照一定规则分成词，比如空格、正则、不处理、文件路径等。</li>
<li>Token Filter 分词后进行二次加工，将输出的单词进行增加、修改、删除。</li>
</ul>
</li>
</ul>
<h2 id="13-Index-Template-和-Dynamic-Template"><a href="#13-Index-Template-和-Dynamic-Template" class="headerlink" title="13. Index Template 和 Dynamic Template"></a>13. Index Template 和 Dynamic Template</h2><ul>
<li>Index Templates 帮助设置 Mappings 和 Settings，按照一定的规则自动匹配到新创建的索引之上。<ul>
<li>模板仅在一个索引被创建时才会有用，模板不会影响已经创建的索引。</li>
<li>可以设置多个索引模板，这些设置会被 merge 在一起。</li>
<li>可以指定 <code>order</code> 的数值，用来控制 merge 的过程。</li>
</ul>
</li>
<li>当一个索引被创建：<ul>
<li>应用 es 默认的 Settings 和 Mappings。</li>
<li>应用 <code>order</code> 值低的 Index Template 中的设定。</li>
<li>用高 <code>order</code> 设置覆盖低 <code>order</code> 设定。</li>
<li>用户指定的 Settings 和 Mappings 覆盖之前的设定。</li>
</ul>
</li>
<li>Dynamic Template 是应用在一个具体的索引上的，结合字段名称，数据类型，来动态设置字段类型。<ul>
<li>比如所有字符串都设置为 keyword，所有 is 开头都为 boolean，所有 long_ 开头都设置为 long 等。</li>
</ul>
</li>
</ul>
<h2 id="14-es-聚合分析"><a href="#14-es-聚合分析" class="headerlink" title="14. es 聚合分析"></a>14. es 聚合分析</h2><ul>
<li>所谓聚合就是数据统计分析，过滤结果。<ul>
<li>Bucket Aggregation 满足一些特定条件的文档的集合。</li>
<li>Metric Aggregation 数学运算，可以对文档字段进行统计分析。</li>
<li>Pipeline Aggregation 对其他的聚合结果进行二次聚合。</li>
<li>Matrix Aggregation 支持对多个字段的操作提供一个结果矩阵。</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(brand) <span class="comment"># Metrix</span></span><br><span class="line"><span class="keyword">FROM</span> cars</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> brand <span class="comment"># Bucket</span></span><br></pre></td></tr></table></figure>
<ul>
<li>聚合功能 <code>aggs</code> 可以叠加也可以嵌套。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">"aggs"</span>:&#123;</span><br><span class="line">    <span class="string">"flight_dest"</span>:&#123;</span><br><span class="line">      <span class="string">"terms"</span>:&#123; <span class="comment"># Bucket</span></span><br><span class="line">        <span class="string">"field"</span>:<span class="string">"DestCountry"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"aggs"</span>:&#123;</span><br><span class="line">        <span class="string">"stats_price"</span>:&#123;</span><br><span class="line">          <span class="string">"stats"</span>:&#123; <span class="comment"># Metrix</span></span><br><span class="line">            <span class="string">"field"</span>:<span class="string">"AvgTicketPrice"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"wather"</span>:&#123;</span><br><span class="line">          <span class="string">"terms"</span>: &#123; <span class="comment"># Bucket</span></span><br><span class="line">            <span class="string">"field"</span>: <span class="string">"DestWeather"</span>,</span><br><span class="line">            <span class="string">"size"</span>: <span class="number">5</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="15-总结"><a href="#15-总结" class="headerlink" title="15. 总结"></a>15. 总结</h2><ul>
<li>判断题：ES 支持使用 Http Put 写入新文档,并通过 Elasticsearch 生成文档 id<ul>
<li>错，需要用 POST 命令创建</li>
</ul>
</li>
<li>判断题：Update 一个文档，需要使用 Http Put<ul>
<li>错，Update 文档，使用 POST，PUT 只能用来做 Index 或者 Create</li>
</ul>
</li>
<li>判断题：Index 一个已存在的文档，旧的文档会先被删除，新的文档再被写入，同时版本号加 1<ul>
<li>对</li>
</ul>
</li>
<li>尝试描述创建一个新的文档到一个不存在的索引中，背后会发生一些什么<ul>
<li>默认情况下，会创建相应的索引，并且自己设置 Mapping，当然，实际情况还是要看是否有合适的 Index Template</li>
</ul>
</li>
<li>ES7 中的合法的 type 是什么<ul>
<li>_doc</li>
</ul>
</li>
<li>精确值和全文的本质区别是什么<ul>
<li>精确值不会被 Analyzer 分词，全文本会</li>
</ul>
</li>
<li>Analyzer 由哪几个部分组成<ul>
<li>三部分，Character Filter + Tokenizer + Token filter</li>
</ul>
</li>
<li>尝试描述 match 和 match_phrase 的区别<ul>
<li>Match 中的 terms 之间是 or 的关系，Match phrase 的 terms 之间是 and 的关系,并且 term 之间位置关系也影响搜索的结果</li>
</ul>
</li>
<li>如果你希望 match_phrase 匹配到更多结果，你应该配置查询中什么参数<ul>
<li>slop</li>
</ul>
</li>
<li>如果 Mapping 的 dynamic 设置成 strict，索引一个包含新增字段的文档时会发生什么<ul>
<li>直接报错</li>
</ul>
</li>
<li>如果 Mapping 的 dynamic 设置成 false，索引一个包含新增字段的文档时会发生什么<ul>
<li>文档被索引，新的字段在 _source 中可见。但是该字段无法被搜索</li>
</ul>
</li>
<li>判断题：可以把一个字段的类型从 integer 改成 long，因为这两个类型是兼容的<ul>
<li>错。字段类型修改，需要重新 reindex</li>
</ul>
</li>
<li>判断题：你可以在 Mapping 文件中为 indexing 和 searching 指定不同的 analyzer<ul>
<li>对。可以在 Mapping 中为 index 和 search 指定不同的 analyzer</li>
</ul>
</li>
<li>判断题：字段类型为 Text 的字段，一定可以被全文搜索<ul>
<li>错。可以通过为 Text 类型的字段指定 Not Indexed，使其无法被搜索</li>
</ul>
</li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="https://github.com/koonchen">Projects</a></li>
         
          <li><a href="https://valeriehu1995.github.io">PigChain</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-安装与准备"><span class="toc-number">1.</span> <span class="toc-text">1. 安装与准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-基本概念"><span class="toc-number">2.</span> <span class="toc-text">2. 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-CRUD-与批量操作"><span class="toc-number">3.</span> <span class="toc-text">3. CRUD 与批量操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Create"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 Create</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Get"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Get</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Index"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Update"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 Update</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Bulk-API"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 Bulk API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-批量读取-mget"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 批量读取 mget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-批量查询-msearch"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 批量查询 msearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-倒排索引"><span class="toc-number">4.</span> <span class="toc-text">4. 倒排索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Analyzer-分词"><span class="toc-number">5.</span> <span class="toc-text">5. Analyzer 分词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Search-API-概览"><span class="toc-number">6.</span> <span class="toc-text">6. Search API 概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-URI-Search-详解"><span class="toc-number">7.</span> <span class="toc-text">7. URI Search 详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Request-Body-与-Query-DSL"><span class="toc-number">8.</span> <span class="toc-text">8. Request Body 与 Query DSL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Query-String-和-Simple-Query-String-查询"><span class="toc-number">9.</span> <span class="toc-text">9. Query String 和 Simple Query String 查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Dynamic-Mapping-和常见字段类型"><span class="toc-number">10.</span> <span class="toc-text">10. Dynamic Mapping 和常见字段类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-显式-Mapping-设置与常见参数"><span class="toc-number">11.</span> <span class="toc-text">11. 显式 Mapping 设置与常见参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-多字段特性与-Mapping-中自定义-Analyzer"><span class="toc-number">12.</span> <span class="toc-text">12. 多字段特性与 Mapping 中自定义 Analyzer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-Index-Template-和-Dynamic-Template"><span class="toc-number">13.</span> <span class="toc-text">13. Index Template 和 Dynamic Template</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-es-聚合分析"><span class="toc-number">14.</span> <span class="toc-text">14. es 聚合分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-总结"><span class="toc-number">15.</span> <span class="toc-text">15. 总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&text=Elasticsearch 入门"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&is_video=false&description=Elasticsearch 入门"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Elasticsearch 入门&body=Check out this article: http://koon.cool/technology/2020-04-01-elasticsearch-learn1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&title=Elasticsearch 入门"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://koon.cool/technology/2020-04-01-elasticsearch-learn1/&name=Elasticsearch 入门&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 Koon Chen
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="https://github.com/koonchen">Projects</a></li>
         
          <li><a href="https://valeriehu1995.github.io">PigChain</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<!-- <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"> -->
<link rel="stylesheet" href="//cdn.staticfile.org/font-awesome/5.2.0/css/all.min.css">
<!-- <link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"> -->
<link rel="stylesheet" href="//cdn.staticfile.org/justifiedGallery/3.6.5/css/justifiedGallery.min.css">

    <!-- jquery -->
<!-- <script src="/lib/jquery/jquery.min.js"></script> -->
<script src="//cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script>
<!-- <script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script> -->
<script src="//cdn.staticfile.org/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-109260587-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
